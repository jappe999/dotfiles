#!/bin/bash

# Credits to Justin Kenyon for creating this script.
# https://github.com/kenyonj/i3-create-config

source_folder="$(dirname $(readlink -f $0))"
export_folder="$HOME/.config/polybar"
module_file="$export_folder/module"
module_dir="$source_folder/modules.d"
includes_file="$module_dir/index.ini"

if [ -f "$includes_file" ]; then
  [ -f "$module_file" ] && rm "$module_file"

  touch "$module_file"

  echo "#### DO NOT EDIT THIS FILE, IT IS GENERATED." >> "$module_file"
  echo "#### EDIT THE FILES HERE: $source_folder/modules.d/**/*" >> "$module_file"

  include_file() {
    echo "
    " >> "$module_file"
    cat "$module_dir/$1" >> "$module_file"
  }

  get_file_name_from_line () {
    stripped_file_name=$(echo $* | cut -c8-)
    echo "$stripped_file_name"
  }

  exec 3< "$includes_file"

  until [ "$done" ]
  do
    read <&3 module_line

    if [ $? != 0 ]; then
      done=1
      continue
    else
      if [[ "$module_line" == "import "* ]]; then
        file_name="$(get_file_name_from_line $module_line)"
        include_file "$file_name"
      fi
    fi
  done

  if [[ "$1" == "restart" || "$1" == "reload" ]]; then
    i3-msg "$1"
  fi
else
  echo "ERROR:"
  echo "Please create the modules import file:"
  echo " $includes_files"
fi
